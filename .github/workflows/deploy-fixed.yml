name: Deploy Shopify Theme

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Shopify CLI
      run: |
        npm install -g @shopify/cli @shopify/theme
        shopify version
        
    - name: Validate theme structure
      run: |
        echo "üîç Validating theme structure..."
        ls -la
        if [ ! -f "layout/theme.liquid" ]; then
          echo "‚ùå Missing layout/theme.liquid"
          exit 1
        fi
        if [ ! -f "config/settings_schema.json" ]; then
          echo "‚ùå Missing config/settings_schema.json" 
          exit 1
        fi
        echo "‚úÖ Theme structure valid"
        echo "üìÅ Theme files:"
        find . -name "*.liquid" | head -10
        
    - name: Deploy to Shopify
      run: |
        echo "üéØ Deploying to Shopify store: ${{ secrets.SHOPIFY_STORE }}"
        echo "Using token: ${SHOPIFY_CLI_THEME_TOKEN:0:10}..."
        
        # Create a .shopify directory for configuration
        mkdir -p .shopify
        
        # Deploy to development theme (no prompts required)
        shopify theme push \
          --store="${{ secrets.SHOPIFY_STORE }}.myshopify.com" \
          --development \
          --force \
          --json
          
      env:
        SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
        
    - name: Success notification
      if: success()
      run: |
        echo "‚úÖ Theme successfully deployed to development!"
        echo "üîó Store: https://${{ secrets.SHOPIFY_STORE }}.myshopify.com"
        echo "üé® Development theme deployed successfully"
        echo "üìã To make this live, publish the development theme via Shopify admin"
        
    - name: Debug information
      if: failure()
      run: |
        echo "‚ùå Deployment failed"
        echo "üìã Debug info:"
        echo "Store: ${{ secrets.SHOPIFY_STORE }}"
        echo "Token present: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN != '' }}"
        ls -la
        find . -name "*.liquid" | wc -l